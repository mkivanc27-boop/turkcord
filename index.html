<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TurkCord</title>

<style>
body{
margin:0;
font-family:Arial;
background:#313338;
color:white;
}

.hidden{display:none}

/* AUTH */
#auth{
height:100vh;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
}

#auth input{
margin:5px;
padding:10px;
width:230px;
}

#auth button{
padding:10px;
width:250px;
cursor:pointer;
}

/* APP */
#app{
display:flex;
height:100vh;
}

/* Servers */
#servers{
width:70px;
background:#1e1f22;
display:flex;
flex-direction:column;
align-items:center;
padding-top:10px;
}

.server{
width:45px;
height:45px;
background:#36393f;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
margin-bottom:10px;
cursor:pointer;
}

.server.active{
background:#5865f2;
}

/* Sidebar */
#sidebar{
width:240px;
background:#2b2d31;
padding:10px;
overflow:auto;
}

/* Chat */
#chat{
flex:1;
display:flex;
flex-direction:column;
}

#messages{
flex:1;
overflow:auto;
padding:10px;
}

.message{
background:#40444b;
padding:8px;
border-radius:8px;
margin-bottom:6px;
}

.me{
background:#5865f2;
}

#input{
display:flex;
}

#input input{
flex:1;
padding:10px;
border:none;
}

#input button{
padding:10px;
border:none;
background:#5865f2;
color:white;
cursor:pointer;
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login / Register</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<div id="servers">
<div class="server" onclick="createServer()">+</div>
<div id="serverList"></div>
</div>

<div id="sidebar">
<h3>Friends</h3>
<input id="friendUid" placeholder="Friend UID">
<button onclick="addFriend()">Add Friend</button>
<div id="friendList"></div>
</div>

<div id="chat">
<div id="messages"></div>

<div id="typing"></div>

<div id="input">
<input id="messageInput" placeholder="Mesaj yaz">
<button onclick="sendMessage()">Send</button>
</div>

</div>
</div>

<script type="module">

/* ================= FIREBASE ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
import {
getAuth,
signInWithEmailAndPassword,
createUserWithEmailAndPassword,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
getFirestore,
collection,
addDoc,
setDoc,
doc,
query,
where,
orderBy,
onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ðŸ”¥ SENÄ°N FIREBASE CONFIG */
const firebaseConfig = {
apiKey: "AIzaSyC98wxJQk8yNZFdE-OJ1Tlpy1ANuaRUT14",
authDomain: "turkcord-47b24.firebaseapp.com",
projectId: "turkcord-47b24",
storageBucket: "turkcord-47b24.firebasestorage.app",
messagingSenderId: "474688300925",
appId: "1:474688300925:web:316134db4b4cb441438e14",
measurementId: "G-S92JHCM9P9"
};

/* ðŸ”¥ INIT */
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= STATE ================= */

let currentServer=null;
let currentRoom=null;

/* ================= AUTH ================= */

window.login=async()=>{

const email=emailInput.value;
const pass=password.value;

try{
await signInWithEmailAndPassword(auth,email,pass);
}
catch{
await createUserWithEmailAndPassword(auth,email,pass);
}

};

onAuthStateChanged(auth,user=>{

if(user){
authDiv.classList.add("hidden");
app.classList.remove("hidden");
loadServers();
loadFriends();
}else{
authDiv.classList.remove("hidden");
app.classList.add("hidden");
}

});

/* ================= SERVER ================= */

window.createServer=async()=>{

const name=prompt("Server adÄ±");
if(!name) return;

await addDoc(collection(db,"servers"),{
name:name,
owner:auth.currentUser.uid,
members:[auth.currentUser.uid]
});

};

function loadServers(){

onSnapshot(collection(db,"servers"),snap=>{

serverList.innerHTML="";

snap.forEach(doc=>{

const data=doc.data();

if(!data.members.includes(auth.currentUser.uid)) return;

const div=document.createElement("div");
div.className="server";
div.innerText=data.name[0];

div.onclick=()=>{
currentServer=doc.id;
currentRoom=doc.id;
loadMessages();
};

serverList.appendChild(div);

});

});

}

/* ================= FRIEND ================= */

window.addFriend=async()=>{

const uid=friendUid.value;
if(!uid) return;

await addDoc(collection(db,"friends"),{
users:[auth.currentUser.uid,uid]
});

alert("Friend Added");

};

function loadFriends(){

onSnapshot(collection(db,"friends"),snap=>{

friendList.innerHTML="";

snap.forEach(doc=>{

const data=doc.data();

if(!data.users.includes(auth.currentUser.uid)) return;

const friend=data.users.find(u=>u!==auth.currentUser.uid);

const div=document.createElement("div");
div.innerText="Friend: "+friend;

div.onclick=()=>{
currentRoom=[auth.currentUser.uid,friend].sort().join("_");
loadMessages();
};

friendList.appendChild(div);

});

});

}

/* ================= MESSAGES ================= */

window.sendMessage=async()=>{

if(!currentRoom) return;

await addDoc(collection(db,"messages"),{
room:currentRoom,
text:messageInput.value,
uid:auth.currentUser.uid,
email:auth.currentUser.email,
time:Date.now()
});

messageInput.value="";

};

function loadMessages(){

const q=query(
collection(db,"messages"),
where("room","==",currentRoom),
orderBy("time")
);

onSnapshot(q,snap=>{

messages.innerHTML="";

snap.forEach(doc=>{

const data=doc.data();

const div=document.createElement("div");
div.className="message";

if(data.uid===auth.currentUser.uid)
div.classList.add("me");

div.innerText=data.email+": "+data.text;

messages.appendChild(div);

});

messages.scrollTop=messages.scrollHeight;

});

}

</script>

</body>
</html>
